import express from 'express';
import ollama from 'ollama';
import cors from 'cors';
import multer from 'multer';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// PDF Parse
let pdfParse;
try {
    const module = await import('pdf-parse/lib/pdf-parse.js');
    pdfParse = module.default;
} catch (e) {
    try {
        pdfParse = (await import('pdf-parse')).default;
    } catch (e2) {
        console.error("âŒ ERRO: pdf-parse nÃ£o encontrado");
        process.exit(1);
    }
}

const app = express();
const upload = multer({ 
    storage: multer.memoryStorage(),
    limits: { fileSize: 15 * 1024 * 1024 }
});

app.use(cors());
app.use(express.json());

app.get('/api/system-info', async (req, res) => {
    try {
        const list = await ollama.list();
        const model = list.models.length > 0 ? list.models[0].name : 'llama3';
        res.json({ platform: process.platform === 'win32' ? 'Windows' : 'Linux/Mac', model, status: 'online' });
    } catch (e) {
        res.json({ platform: 'Unknown', model: 'llama3', status: 'offline' });
    }
});

app.post('/api/screen', upload.single('pdf'), async (req, res) => {
    const startTime = Date.now();
    console.log(`\n[${new Date().toISOString()}] Nova anÃ¡lise`);

    try {
        const { jd } = req.body;
        
        if (!req.file) {
            return res.status(400).json({ error: "Arquivo PDF nÃ£o encontrado.", tip: "Selecione um .pdf vÃ¡lido." });
        }
        
        if (!jd || jd.trim().length < 20) {
            return res.status(400).json({ error: "DescriÃ§Ã£o da vaga muito curta.", tip: "Cole a descriÃ§Ã£o completa." });
        }

        console.log(`[PARSE] Arquivo: ${req.file.originalname}`);
        
        let resumeText = "";
        
        try {
            const data = await pdfParse(req.file.buffer);
            resumeText = data.text.trim();
            const wordCount = resumeText.split(/\s+/).filter(w => w.length > 0).length;
            
            console.log(`[OK] ${wordCount} palavras extraÃ­das`);

            if (wordCount < 30) {
                return res.status(400).json({ 
                    error: "PDF sem texto suficiente.",
                    tip: "Use um PDF com texto selecionÃ¡vel."
                });
            }

        } catch (pdfError) {
            console.error(`[ERRO PDF] ${pdfError.message}`);
            return res.status(400).json({ 
                error: "NÃ£o foi possÃ­vel ler o PDF.",
                tip: "Verifique se nÃ£o estÃ¡ corrompido."
            });
        }

        // ------------------------------------------------------------------
        // ğŸ¯ CRITICAL ANALYSIS PROMPT - Realistic & Demanding
        // ------------------------------------------------------------------
        const systemPrompt = `You are a DEMANDING Senior Recruiter with 15+ years of experience. You've seen thousands of resumes and have HIGH STANDARDS.

YOUR EVALUATION PHILOSOPHY:
- Be SKEPTICAL by default. Candidates often oversell themselves.
- "Exposure to" or "familiar with" is NOT the same as "expert in"
- Years of experience matter. Junior candidates can't fake seniority.
- Job hopping (< 1 year per role) is a RED FLAG
- Vague achievements without metrics are suspicious
- Missing keywords from JD are GAPS, not "learning opportunities"
- Cultural fit is secondary - SKILLS MATCH is primary

SCORING GUIDELINES (be strict):
- 90-100: Near-perfect match. All requirements met. Rare.
- 75-89: Strong match with minor gaps. Worth interviewing.
- 60-74: Decent match but significant gaps. Maybe interview.
- 40-59: Weak match. Major requirements missing. Likely reject.
- 0-39: Poor match. Wrong profile entirely. Hard reject.

CRITICAL ANALYSIS REQUIREMENTS:
1. List SPECIFIC missing skills from the JD
2. Flag experience gaps (years, seniority level)
3. Note any red flags (job hopping, vague descriptions, gaps)
4. Be direct about deal-breakers
5. Don't sugarcoat - hiring managers want the truth

OUTPUT FORMAT (HTML):
<div class="analysis">
  <div class="score">
    <span class="number">[REALISTIC SCORE 0-100]</span>
    <span class="label">Match Score</span>
  </div>
  
  <h3>âœ… Pontos Fortes</h3>
  <ul>
    <li>[Concrete strength with evidence from resume]</li>
  </ul>
  
  <h3>ğŸš¨ Gaps CrÃ­ticos</h3>
  <ul>
    <li><strong>[DEAL-BREAKER]</strong> [Missing critical requirement]</li>
    <li><strong>[MAJOR]</strong> [Significant gap]</li>
    <li><strong>[MINOR]</strong> [Nice-to-have missing]</li>
  </ul>
  
  <h3>ğŸš© Red Flags</h3>
  <ul>
    <li>[Any concerns: job hopping, vague experience, overqualified, etc.]</li>
  </ul>
  
  <h3>ğŸ¯ Veredito</h3>
  <p><strong>[AVANÃ‡AR / TALVEZ / REJEITAR]</strong> - [Brutally honest 2-sentence assessment. Would YOU spend 45 min interviewing this person?]</p>
</div>

Remember: Your job is to SAVE the hiring manager's time. A false positive (bad hire) costs 6+ months of salary. Be critical.`;

        console.log(`[AI] Enviando para Ollama...`);
        
        const response = await ollama.chat({
            model: 'dolphin-llama3:latest',
            messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: `JOB DESCRIPTION:\n${jd}\n\n---\n\nCANDIDATE RESUME:\n${resumeText}` }
            ],
        });

        const duration = ((Date.now() - startTime) / 1000).toFixed(2);
        console.log(`[DONE] ${duration}s`);

        res.json({ 
            analysis: response.message.content,
            meta: { duration: `${duration}s`, resumeWords: resumeText.split(/\s+/).length, model: 'dolphin-llama3' }
        });

    } catch (error) {
        console.error("âŒ ERRO:", error.message);
        res.status(500).json({ error: "Erro interno.", tip: "Verifique se Ollama estÃ¡ rodando." });
    }
});

const PORT = process.env.PORT || 3001;
app.listen(PORT, () => {
    console.log("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("â•‘     ğŸ‘» GHOST-SOURCER v4.1 (CRITICAL)   â•‘");
    console.log("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    console.log(`â•‘  ğŸŒ http://localhost:${PORT}               â•‘`);
    console.log("â•‘  ğŸ”’ 100% Local | âš ï¸  Strict Mode        â•‘");
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
});
